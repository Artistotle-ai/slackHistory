version: 0.2

phases:
  install:
    # Standard images don't support runtime-versions for Node.js 20/22 (only 8, 10, 12)
    # Check if Node.js is pre-installed, otherwise use amazon-linux-extras or NodeSource
    commands:
      - echo "Checking for Node.js..."
      - node --version || echo "Node.js not found"
      - |
        # Always install Node.js 20+ (upgrade if needed)
        echo "Current Node.js version: $(node --version 2>/dev/null || echo 'not installed')"
        echo "Installing/upgrading to Node.js 20 via NodeSource..."
        curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
        sudo yum install -y nodejs --skip-broken
      - node --version
      - npm --version
      - echo Building slack-shared dependency
      - |
        if [ -d "functions/slack-shared" ]; then
          cd functions/slack-shared
          npm ci || npm install
          npm run build || (echo "Build failed!" && exit 1)
          # Tests temporarily disabled in CI - running locally
          # npm test || true
          echo "✓ slack-shared built successfully"
          cd ../..
        else
          echo "ERROR: functions/slack-shared directory not found!"
          exit 1
        fi
  build:
    commands:
      - echo "Building all Lambda functions"
      - echo "Building message-listener..."
      - |
        if [ -d "functions/message-listener" ]; then
          cd functions/message-listener
          npm ci || npm install
          npm run build || (echo "Build failed!" && exit 1)
          # Tests temporarily disabled in CI - running locally
          # npm test || true
          echo "✓ message-listener built successfully"
          cd ../..
        else
          echo "ERROR: functions/message-listener directory not found!"
          exit 1
        fi
      
      - echo "Building file-processor..."
      - |
        if [ -d "functions/file-processor" ]; then
          cd functions/file-processor
          npm ci || npm install
          npm run build || (echo "Build failed!" && exit 1)
          # Tests temporarily disabled in CI - running locally
          # npm test || true
          echo "✓ file-processor built successfully"
          cd ../..
        else
          echo "ERROR: functions/file-processor directory not found!"
          exit 1
        fi
      
      - echo "Building oauth-callback..."
      - |
        if [ -d "functions/oauth-callback" ]; then
          cd functions/oauth-callback
          npm ci || npm install
          npm run build || (echo "Build failed!" && exit 1)
          # Tests temporarily disabled in CI - running locally
          # npm test || true
          echo "✓ oauth-callback built successfully"
          cd ../..
        else
          echo "ERROR: functions/oauth-callback directory not found!"
          exit 1
        fi
      
      - echo "All Node.js apps built successfully"
      - echo ""
      - echo "PHASE 2 - Creating deployment packages"
      - echo "Creating package for message-listener..."
      - |
        cd functions/message-listener
        npm prune --production || true
        if [ -d "dist" ]; then
          cd dist
          zip -rq ../../../message-listener-function.zip * 2>&1 | head -20 || true
          cd ..
        fi
        if [ -d "node_modules" ]; then
          zip -rq ../../message-listener-function.zip node_modules 2>&1 | head -20 || true
        fi
        cd ../..
        echo "✓ message-listener package created"
      - echo "Creating package for file-processor..."
      - |
        cd functions/file-processor
        npm prune --production || true
        if [ -d "dist" ]; then
          cd dist
          zip -rq ../../../file-processor-function.zip * 2>&1 | head -20 || true
          cd ..
        fi
        if [ -d "node_modules" ]; then
          zip -rq ../../file-processor-function.zip node_modules 2>&1 | head -20 || true
        fi
        cd ../..
        echo "✓ file-processor package created"
      - echo "Creating package for oauth-callback..."
      - |
        cd functions/oauth-callback
        npm prune --production || true
        if [ -d "dist" ]; then
          cd dist
          zip -rq ../../../oauth-callback-function.zip * 2>&1 | head -20 || true
          cd ..
        fi
        if [ -d "node_modules" ]; then
          zip -rq ../../oauth-callback-function.zip node_modules 2>&1 | head -20 || true
        fi
        cd ../..
        echo "✓ oauth-callback package created"
      
      - echo "All deployment packages created"
      - echo ""
      - echo "PHASE 3 - Deploying Lambda functions"
      - echo "Deploying message-listener..."
      - |
        FUNCTION_NAME="${APP_PREFIX}MessageListener"
        aws lambda update-function-code --function-name "$FUNCTION_NAME" --zip-file fileb://message-listener-function.zip
        echo "✓ message-listener deployed"
      - echo "Deploying file-processor..."
      - |
        FUNCTION_NAME="${APP_PREFIX}FileProcessor"
        aws lambda update-function-code --function-name "$FUNCTION_NAME" --zip-file fileb://file-processor-function.zip
        echo "✓ file-processor deployed"
      - echo "Deploying oauth-callback..."
      - |
        FUNCTION_NAME="${APP_PREFIX}OAuthCallback"
        aws lambda update-function-code --function-name "$FUNCTION_NAME" --zip-file fileb://oauth-callback-function.zip
        echo "✓ oauth-callback deployed"
      
      - echo ""
      - echo "All Lambda functions deployed successfully"
